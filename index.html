<!DOCTYPE html><html><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;"><meta http-equiv="x-dns-prefetch-control" content="off"><script src="https://puc.poecdn.net/authenticated_preview_page/standard.3ef2c256959faf5a756d.js"></script>
    <meta charset="utf-8">
    <title>Dynamic Variables Analysis</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://puc.poecdn.net/authenticated_preview_page/disableWebRTC.9710cebe07429a9e8e06.js"></script><meta name="x-poe-allow-downloads" content="true"><meta name="x-poe-datastore-behavior" content="disabled"><script src="https://puc.poecdn.net/authenticated_preview_page/tw.b9024aecac666455e183.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script><script src="https://puc.poecdn.net/authenticated_preview_page/deps.faccd16000d314dc16d5.js"></script><script src="https://puc.poecdn.net/authenticated_preview_page/exports.b0f0f482cdeb5302b0b9.js"></script><script src="https://puc.poecdn.net/authenticated_preview_page/renderer.75c73ae6b4235f62945a.js"></script><script>Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; } function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; }var _react = require('react'); var _react2 = _interopRequireDefault(_react);
var _lucidereact = require('lucide-react');

// --- 0. URL Sharing: Array-of-Arrays Encoding (keyless) ---

// Structure definitions (index-based, no keys):
// row: [id, name, expression]
// mod: [id, targetVar, type, value]
// buff: [id, name, mods[]]
// buffSet: [id, name, activeIds[]]
// state: [rows[], buffs[], buffSets[], activeBuffIds[], activeBuffSetId, activeTargetId]

// Convert state object to compact array format
const stateToArrays = (state) => {
  // Convert rows: [{id, name, expression}] -> [[id, name, expression], ...]
  const rows = state.rows.map(r => [r.id, r.name, r.expression]);

  // Convert mods: [{id, targetVar, type, value}] -> [[id, targetVar, type, value], ...]
  // Convert buffs: [{id, name, mods}] -> [[id, name, [[mod], ...]], ...]
  const buffs = state.buffs.map(b => [
    b.id,
    b.name,
    b.mods.map(m => [m.id, m.targetVar, m.type, m.value])
  ]);

  // Convert buffSets: [{id, name, activeIds}] -> [[id, name, [activeIds]], ...]
  const buffSets = state.buffSets.map(s => [s.id, s.name, s.activeIds]);

  // Return compact array: [rows, buffs, buffSets, activeBuffIds, activeBuffSetId, activeTargetId]
  return [
    rows,
    buffs,
    buffSets,
    state.activeBuffIds,
    state.activeBuffSetId,
    state.activeTargetId
  ];
};

// Convert compact array format back to state object
const arraysToState = (arr) => {
  if (!Array.isArray(arr) || arr.length < 6) return null;

  const [rowsArr, buffsArr, buffSetsArr, activeBuffIds, activeBuffSetId, activeTargetId] = arr;

  // Convert rows back: [[id, name, expression], ...] -> [{id, name, expression}, ...]
  const rows = rowsArr.map(r => ({
    id: r[0],
    name: r[1],
    expression: r[2]
  }));

  // Convert buffs back
  const buffs = buffsArr.map(b => ({
    id: b[0],
    name: b[1],
    mods: b[2].map(m => ({
      id: m[0],
      targetVar: m[1],
      type: m[2],
      value: m[3]
    }))
  }));

  // Convert buffSets back
  const buffSets = buffSetsArr.map(s => ({
    id: s[0],
    name: s[1],
    activeIds: s[2]
  }));

  return {
    rows,
    buffs,
    buffSets,
    activeBuffIds,
    activeBuffSetId,
    activeTargetId
  };
};

// Encode state to URL-safe string
const encodeStateToUrl = (state) => {
  try {
    const compact = stateToArrays(state);
    const json = JSON.stringify(compact);
    return LZString.compressToEncodedURIComponent(json);
  } catch (e) {
    console.log('Failed to encode state:', e);
    return null;
  }
};

// Decode URL string back to state
const decodeStateFromUrl = (encoded) => {
  try {
    const json = LZString.decompressFromEncodedURIComponent(encoded);
    if (!json) return null;
    const compact = JSON.parse(json);
    return arraysToState(compact);
  } catch (e) {
    console.log('Failed to decode state:', e);
    return null;
  }
};

// Parse URL for shared data
const getSharedStateFromUrl = () => {
  try {
    const params = new URLSearchParams(window.location.search);
    const data = params.get('d');
    if (data) {
      return decodeStateFromUrl(data);
    }
  } catch (e) {
    console.log('Failed to parse URL:', e);
  }
  return null;
};

// --- 1. Tokenizer & Parser Logic ---

const tokenize = (input) => {
  const tokens = [];
  const regex = /\s*([()+\-*/^]|(?:\d+\.?\d*)|\w+)\s*/g;
  let match;
  while ((match = regex.exec(input)) !== null) {
    if (match.index === regex.lastIndex) regex.lastIndex++;
    if (match[1]) tokens.push(match[1]);
  }
  return tokens;
};

class Node {
  constructor(type, value, left = null, right = null, label = null) {
    this.type = type; 
    this.value = value;
    this.left = left;
    this.right = right;
    this.label = label;
    this.isBuff = false; 
  }
}

const parse = (tokens, definedVars) => {
  let cursor = 0;
  const peek = () => tokens[cursor];
  const consume = () => tokens[cursor++];

  const parseExpression = () => parseAddSub();

  const parseAddSub = () => {
    let left = parseMulDiv();
    while (peek() === '+' || peek() === '-') {
      const op = consume();
      const right = parseMulDiv();
      left = new Node('operator', op, left, right);
    }
    return left;
  };

  const parseMulDiv = () => {
    let left = parsePrimary();
    while (peek() === '*' || peek() === '/') {
      const op = consume();
      const right = parsePrimary();
      left = new Node('operator', op, left, right);
    }
    return left;
  };

  const parsePrimary = () => {
    const token = consume();
    if (!token) throw new Error("Unexpected end");

    if (!isNaN(parseFloat(token))) {
      return new Node('value', parseFloat(token));
    }

    if (token === '(') {
      const node = parseExpression();
      if (consume() !== ')') throw new Error("Missing )");
      return node; 
    }

    if (definedVars[token]) {
      return new Node('reference', null, null, null, token);
    }

    throw new Error(`Unknown: ${token}`);
  };

  const root = parseExpression();
  if (cursor < tokens.length) throw new Error(`Unexpected token: ${tokens[cursor]}`);
  return root;
};

const evaluateTree = (node, computedContext, depth = 0) => {
  if (depth > 50) throw new Error("Circular dependency or too deep");
  if (!node) return 0;
  if (node.type === 'value') return node.value;
  
  if (node.type === 'reference') {
    return computedContext[node.label] ? computedContext[node.label].value : 0;
  }
  
  if (node.type === 'operator') {
    const l = evaluateTree(node.left, computedContext, depth + 1);
    const r = evaluateTree(node.right, computedContext, depth + 1);
    switch (node.value) {
      case '+': return l + r;
      case '-': return l - r;
      case '*': return l * r;
      case '/': return r === 0 ? 0 : l / r; 
      default: return 0;
    }
  }
  return 0;
};

// --- 2. Visual Components (Memoized) ---

const OperatorDisplay = _react.memo.call(void 0, ({ op, isBuff }) => (
  _react2.default.createElement('span', { className: `mx-1 font-bold font-mono ${isBuff ? 'text-amber-500' : 'text-slate-400'}`,}
    , op
  )
));

const ValueDisplay = _react.memo.call(void 0, ({ val, isBuff }) => (
  _react2.default.createElement('span', { className: `font-mono font-semibold ${isBuff ? 'text-amber-600' : 'text-slate-800'}`,}
    , Number(val).toFixed(2).replace(/\.00$/, '')
  )
));

const ParenDisplay = _react.memo.call(void 0, ({ children }) => (
  _react2.default.createElement('div', { className: "inline-flex items-center mx-0.5"  ,}
    , _react2.default.createElement('span', { className: "text-slate-300 text-lg font-light"  ,}, "(")
    , children
    , _react2.default.createElement('span', { className: "text-slate-300 text-lg font-light"  ,}, ")")
  )
));

const BraceDisplay = _react.memo.call(void 0, ({ label, children, result, isBuffed }) => {
  return (
    _react2.default.createElement('div', { className: "inline-flex flex-col items-center mx-1 group relative align-top"      ,}
      , _react2.default.createElement('div', { className: "px-1 z-10 flex items-center"   ,}
        , children
      )
      , _react2.default.createElement('div', { className: `w-full h-2 border-b-2 border-l-2 border-r-2 rounded-b-md mt-[1px] relative flex justify-center ${isBuffed ? 'border-amber-300' : 'border-indigo-300'}`,}
         , _react2.default.createElement('div', { className: `w-[2px] h-2 -mb-2 ${isBuffed ? 'bg-amber-300' : 'bg-indigo-300'}`,})
      )
      , _react2.default.createElement('div', { className: "mt-1 flex flex-col items-center"   ,}
        , _react2.default.createElement('span', { className: `text-xs font-bold px-1 rounded border whitespace-nowrap flex items-center gap-1 ${isBuffed ? 'text-amber-700 bg-amber-50 border-amber-200' : 'text-indigo-600 bg-indigo-50 border-indigo-100'}`,}
          , label
          , isBuffed && _react2.default.createElement(_lucidereact.Zap, { size: 8, fill: "currentColor",} )
        )
        , _react2.default.createElement('span', { className: "opacity-0 group-hover:opacity-100 absolute top-full mt-6 text-[10px] bg-slate-800 text-white px-2 py-1 rounded transition-opacity whitespace-nowrap z-20 pointer-events-none"              ,}, "Current Value: "
            , _optionalChain([result, 'optionalAccess', _ => _.toLocaleString, 'call', _2 => _2()])
        )
      )
    )
  );
});

const FormulaTreeVisualizer = _react.memo.call(void 0, ({ node, computedContext }) => {
  if (!node) return null;

  if (node.type === 'value') {
    return _react2.default.createElement(ValueDisplay, { val: node.value, isBuff: node.isBuff,} );
  }

  if (node.type === 'operator') {
    return (
      _react2.default.createElement('div', { className: "inline-flex items-center align-baseline"  ,}
        , _react2.default.createElement(FormulaTreeVisualizer, { node: node.left, computedContext: computedContext,} )
        , _react2.default.createElement(OperatorDisplay, { op: node.value, isBuff: node.isBuff,} )
        , _react2.default.createElement(FormulaTreeVisualizer, { node: node.right, computedContext: computedContext,} )
      )
    );
  }

  if (node.type === 'paren') {
    return (
      _react2.default.createElement(ParenDisplay, null
        , _react2.default.createElement(FormulaTreeVisualizer, { node: node.content, computedContext: computedContext,} )
      )
    );
  }

  if (node.type === 'reference') {
    const ctx = computedContext[node.label];
    const val = _optionalChain([ctx, 'optionalAccess', _3 => _3.value]) || 0;
    const targetNode = _optionalChain([ctx, 'optionalAccess', _4 => _4.displayTree]); 
    
    return (
      _react2.default.createElement(BraceDisplay, { label: node.label, result: val, isBuffed: _optionalChain([ctx, 'optionalAccess', _5 => _5.isBuffed]),}
        , _react2.default.createElement(FormulaTreeVisualizer, { node: targetNode, computedContext: computedContext,} )
      )
    );
  }

  return null;
});


// --- 3. Core Calculation Engine ---

const calculateSystem = (rows, buffs, activeBuffIds) => {
  const computed = {};
  const errors = {};

  const activeModsByTarget = {};
  const buffBreakdownByTarget = {}; // Track individual buff contributions

  buffs.forEach(buff => {
    if (activeBuffIds.has(buff.id)) {
      buff.mods.forEach(mod => {
        if (!activeModsByTarget[mod.targetVar]) {
          activeModsByTarget[mod.targetVar] = { mult: 0, flat: 0 };
        }
        if (!buffBreakdownByTarget[mod.targetVar]) {
          buffBreakdownByTarget[mod.targetVar] = [];
        }

        const modValue = parseFloat(mod.value) || 0;
        if (mod.type === 'mult') {
          activeModsByTarget[mod.targetVar].mult += modValue;
        } else {
          activeModsByTarget[mod.targetVar].flat += modValue;
        }

        // Track individual buff contribution
        buffBreakdownByTarget[mod.targetVar].push({
          buffId: buff.id,
          buffName: buff.name,
          type: mod.type,
          value: modValue
        });
      });
    }
  });

  rows.forEach(row => {
    try {
      if (!row.name) throw new Error("Name required");
      if (!row.expression) throw new Error("Expr required");

      const tokens = tokenize(row.expression);
      const originalTree = parse(tokens, computed);
      
      let value = evaluateTree(originalTree, computed);

      const mods = activeModsByTarget[row.name];
      let displayTree = originalTree;

      if (mods) {
        value = value * (1 + mods.mult) + mods.flat;

        if (mods.mult !== 0) {
          let leftNode = displayTree;
          if (leftNode.type === 'operator') {
            leftNode = new Node('paren', null, null, null, null);
            leftNode.content = displayTree;
          }
          const multNode = new Node('value', 1 + mods.mult);
          multNode.isBuff = true;
          const opNode = new Node('operator', '*', leftNode, multNode);
          opNode.isBuff = true;
          displayTree = opNode;
        }

        if (mods.flat !== 0) {
          const op = mods.flat > 0 ? '+' : '-';
          const absFlat = Math.abs(mods.flat);
          const flatNode = new Node('value', absFlat);
          flatNode.isBuff = true;
          const opNode = new Node('operator', op, displayTree, flatNode);
          opNode.isBuff = true;
          displayTree = opNode;
        }
      }
      
      computed[row.name] = {
        tree: originalTree,
        displayTree: displayTree,
        value: value,
        isBuffed: !!mods,
        buffBreakdown: buffBreakdownByTarget[row.name] || []
      };
    } catch (e) {
      errors[row.id] = e.message;
    }
  });

  return { computed, errors };
};


// --- 4. LocalStorage Helper ---

const STORAGE_KEY = 'logic-chain-builder-data';

const isLocalStorageAvailable = () => {
  try {
    const storage = window['localStorage'];
    const testKey = '__ls_test__';
    storage.setItem(testKey, testKey);
    storage.removeItem(testKey);
    return true;
  } catch (e) {
    return false;
  }
};

const storageAvailable = isLocalStorageAvailable();

const getStorage = () => window['localStorage'];

const loadFromStorage = () => {
  if (!storageAvailable) return null;
  try {
    const data = getStorage().getItem(STORAGE_KEY);
    if (!data) return null;
    return JSON.parse(data);
  } catch (e) {
    console.log('Failed to load from localStorage:', e);
    return null;
  }
};

const saveToStorage = (data) => {
  if (!storageAvailable) return false;
  try {
    getStorage().setItem(STORAGE_KEY, JSON.stringify(data));
    return true;
  } catch (e) {
    console.log('Failed to save to localStorage:', e);
    return false;
  }
};

// Check if URL has shared data (without loading it yet)
const getPendingSharedState = () => {
  try {
    const params = new URLSearchParams(window.location.search);
    const data = params.get('d');
    if (data) {
      return decodeStateFromUrl(data);
    }
  } catch (e) {
    console.log('Failed to parse URL:', e);
  }
  return null;
};

const getInitialState = () => {
  // Only load from localStorage initially; URL state requires confirmation
  const saved = loadFromStorage();

  if (saved) {
    return {
      rows: saved.rows || [
        { id: 'r1', name: 'Base', expression: '100' },
        { id: 'r2', name: 'Bonus', expression: '50' },
        { id: 'r3', name: 'Total', expression: '(Base + Bonus) * 2' },
      ],
      activeTargetId: saved.activeTargetId || 'r3',
      buffs: saved.buffs || [
        { id: 'b1', name: 'Heroism', mods: [{ id: 'm1', targetVar: 'Base', type: 'mult', value: 0.1 }] }
      ],
      activeBuffIds: new Set(saved.activeBuffIds || ['b1']),
      buffSets: saved.buffSets || [{ id: 'bs1', name: 'Standard Raid', activeIds: ['b1'] }],
      activeBuffSetId: saved.activeBuffSetId || 'bs1'
    };
  }
  return {
    rows: [
      { id: 'r1', name: 'Base', expression: '100' },
      { id: 'r2', name: 'Bonus', expression: '50' },
      { id: 'r3', name: 'Total', expression: '(Base + Bonus) * 2' },
    ],
    activeTargetId: 'r3',
    buffs: [
      { id: 'b1', name: 'Heroism', mods: [{ id: 'm1', targetVar: 'Base', type: 'mult', value: 0.1 }] }
    ],
    activeBuffIds: new Set(['b1']),
    buffSets: [{ id: 'bs1', name: 'Standard Raid', activeIds: ['b1'] }],
    activeBuffSetId: 'bs1'
  };
};

// --- 5. Main Application ---

 function UnifiedFormulaBuilder() {
  // --- State ---
  const initialState = _react.useMemo.call(void 0, () => getInitialState(), []);

  const [rows, setRows] = _react.useState.call(void 0, initialState.rows);
  const [activeTargetId, setActiveTargetId] = _react.useState.call(void 0, initialState.activeTargetId);
  const [buffs, setBuffs] = _react.useState.call(void 0, initialState.buffs);
  const [activeBuffIds, setActiveBuffIds] = _react.useState.call(void 0, initialState.activeBuffIds);
  const [buffSets, setBuffSets] = _react.useState.call(void 0, initialState.buffSets);
  const [activeBuffSetId, setActiveBuffSetId] = _react.useState.call(void 0, initialState.activeBuffSetId);
  
  const mainResult = _react.useMemo.call(void 0, () => {
    return calculateSystem(rows, buffs, activeBuffIds);
  }, [rows, buffs, activeBuffIds]);

  // Auto-save to localStorage when state changes
  _react.useEffect.call(void 0, () => {
    if (storageAvailable) {
      saveToStorage({
        rows,
        buffs,
        buffSets,
        activeBuffIds: Array.from(activeBuffIds),
        activeBuffSetId,
        activeTargetId
      });
    }
  }, [rows, buffs, buffSets, activeBuffIds, activeBuffSetId, activeTargetId]);

  const [previews, setPreviews] = _react.useState.call(void 0, {});
  // Renamed variable below to avoid collision
  const [buffSetPreviews, setBuffSetPreviews] = _react.useState.call(void 0, {});
  const [isLoading, setIsLoading] = _react.useState.call(void 0, false);
  const [importError, setImportError] = _react.useState.call(void 0, null);
  const [isCalculatingHypotheticals, setIsCalculatingHypotheticals] = _react.useState.call(void 0, false);
  const [shareStatus, setShareStatus] = _react.useState.call(void 0, null); // null, 'copying', 'copied', 'error'
  const [pendingSharedState, setPendingSharedState] = _react.useState.call(void 0, () => getPendingSharedState());
  const [showUrlBanner, setShowUrlBanner] = _react.useState.call(void 0, false);
  const fileInputRef = _react.useRef.call(void 0, null);

  // Drag and drop state
  const [draggingBuffSetId, setDraggingBuffSetId] = _react.useState.call(void 0, null);
  const [draggingBuffId, setDraggingBuffId] = _react.useState.call(void 0, null);
  const [dragOverBuffSetId, setDragOverBuffSetId] = _react.useState.call(void 0, null);
  const [dragOverBuffId, setDragOverBuffId] = _react.useState.call(void 0, null);

  // --- Logic: Debounced Preview Calculation ---
  _react.useEffect.call(void 0, () => {
    setIsCalculatingHypotheticals(true);
    const timer = setTimeout(() => {
        const activeRow = rows.find(r => r.id === activeTargetId);
        if (!activeRow) {
            setIsCalculatingHypotheticals(false);
            return;
        }
    
        const targetName = activeRow.name;
        const currentTargetValue = _optionalChain([mainResult, 'access', _6 => _6.computed, 'access', _7 => _7[targetName], 'optionalAccess', _8 => _8.value]) || 0;
        
        // 1. Calculate Individual Buff Deltas
        const newPreviews = {};
        buffs.forEach(buff => {
            const hypotheticalIds = new Set(activeBuffIds);
            
            if (hypotheticalIds.has(buff.id)) {
                hypotheticalIds.delete(buff.id);
            } else {
                hypotheticalIds.add(buff.id);
            }
            
            const hypoResult = calculateSystem(rows, buffs, hypotheticalIds);
            const hypoValue = _optionalChain([hypoResult, 'access', _9 => _9.computed, 'access', _10 => _10[targetName], 'optionalAccess', _11 => _11.value]) || 0;
            const delta = hypoValue - currentTargetValue;
            
            let percent = 0;
            if (currentTargetValue !== 0) {
              percent = (delta / Math.abs(currentTargetValue)) * 100;
            } else if (delta !== 0) {
                percent = delta > 0 ? 100 : -100;
            }
    
            newPreviews[buff.id] = {
              value: hypoValue,
              delta: delta,
              percent: percent
            };
        });

        // 2. Calculate Buff Set Deltas
        const newSetPreviews = {};
        buffSets.forEach(set => {
            // Skip calculation if the set is exactly the same as current
            const setIds = new Set(set.activeIds);
            
            // Basic set equality check
            let isSame = setIds.size === activeBuffIds.size;
            if (isSame) {
                for (let a of setIds) if (!activeBuffIds.has(a)) { isSame = false; break; }
            }

            if (isSame) {
                 newSetPreviews[set.id] = { delta: 0, percent: 0, isCurrent: true };
            } else {
                const hypoResult = calculateSystem(rows, buffs, setIds);
                const hypoValue = _optionalChain([hypoResult, 'access', _12 => _12.computed, 'access', _13 => _13[targetName], 'optionalAccess', _14 => _14.value]) || 0;
                const delta = hypoValue - currentTargetValue;
                
                let percent = 0;
                if (currentTargetValue !== 0) {
                    percent = (delta / Math.abs(currentTargetValue)) * 100;
                } else if (delta !== 0) {
                    percent = delta > 0 ? 100 : -100;
                }

                newSetPreviews[set.id] = {
                    delta: delta,
                    percent: percent,
                    isCurrent: false
                };
            }
        });
        
        setPreviews(newPreviews);
        setBuffSetPreviews(newSetPreviews);
        setIsCalculatingHypotheticals(false);
    }, 300); 

    return () => clearTimeout(timer);
  }, [rows, buffs, activeBuffIds, activeTargetId, mainResult, buffSets]);

  // --- Handlers ---

  const addRowAt = (index) => {
    const id = Math.random().toString(36).substr(2, 9);
    const newRows = [...rows];
    newRows.splice(index, 0, { id, name: '', expression: '' });
    setRows(newRows);
  };

  const removeRow = (index) => {
    if (rows.length <= 1) return;
    const idToRemove = rows[index].id;
    const newRows = [...rows];
    newRows.splice(index, 1);
    setRows(newRows);

    if (activeTargetId === idToRemove) {
        setActiveTargetId(newRows[newRows.length - 1].id);
    }
  };

  const updateRow = (index, field, value) => {
    const newRows = [...rows];
    newRows[index][field] = value;
    setRows(newRows);
  };

  const toggleBuff = (id) => {
    const newSet = new Set(activeBuffIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setActiveBuffIds(newSet);
  };

  const addBuff = () => {
    const id = Math.random().toString(36).substr(2, 9);
    setBuffs([...buffs, { id, name: 'New Buff', mods: [] }]);
  };

  const removeBuff = (index) => {
    const newBuffs = [...buffs];
    newBuffs.splice(index, 1);
    setBuffs(newBuffs);
  };

  const updateBuffName = (index, val) => {
    const newBuffs = [...buffs];
    newBuffs[index].name = val;
    setBuffs(newBuffs);
  };

  const addModToBuff = (buffIndex) => {
    const newBuffs = [...buffs];
    const target = rows.length > 0 ? rows[0].name : '';
    newBuffs[buffIndex].mods.push({
      id: Math.random().toString(36).substr(2, 9),
      targetVar: target,
      type: 'mult',
      value: 0.1
    });
    setBuffs(newBuffs);
  };

  const updateMod = (buffIndex, modIndex, field, val) => {
    const newBuffs = [...buffs];
    newBuffs[buffIndex].mods[modIndex][field] = val;
    setBuffs(newBuffs);
  };

  const removeMod = (buffIndex, modIndex) => {
    const newBuffs = [...buffs];
    newBuffs[buffIndex].mods.splice(modIndex, 1);
    setBuffs(newBuffs);
  };

  // --- Buff Set Handlers ---

  const createBuffSet = () => {
      const newSetId = Math.random().toString(36).substr(2, 9);
      const newSet = {
          id: newSetId,
          name: 'New Set',
          activeIds: Array.from(activeBuffIds)
      };
      setBuffSets([...buffSets, newSet]);
      setActiveBuffSetId(newSetId);
  };

  const updateBuffSet = (setId) => {
    setBuffSets(buffSets.map(set => {
        if (set.id === setId) {
            return { ...set, activeIds: Array.from(activeBuffIds) };
        }
        return set;
    }));
  };

  const loadBuffSet = (set) => {
      setActiveBuffIds(new Set(set.activeIds));
      setActiveBuffSetId(set.id);
  };

  const deleteBuffSet = (id) => {
      setBuffSets(buffSets.filter(s => s.id !== id));
      if (activeBuffSetId === id) {
          setActiveBuffSetId(null);
      }
  };

  // --- Drag and Drop Handlers for Buff Sets ---
  const handleBuffSetDragStart = (e, setId) => {
    setDraggingBuffSetId(setId);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', setId);
  };

  const handleBuffSetDragOver = (e, setId) => {
    e.preventDefault();
    if (draggingBuffSetId && draggingBuffSetId !== setId) {
      setDragOverBuffSetId(setId);
    }
  };

  const handleBuffSetDragLeave = () => {
    setDragOverBuffSetId(null);
  };

  const handleBuffSetDrop = (e, targetId) => {
    e.preventDefault();
    if (!draggingBuffSetId || draggingBuffSetId === targetId) {
      setDraggingBuffSetId(null);
      setDragOverBuffSetId(null);
      return;
    }
    const fromIndex = buffSets.findIndex(s => s.id === draggingBuffSetId);
    const toIndex = buffSets.findIndex(s => s.id === targetId);
    if (fromIndex !== -1 && toIndex !== -1) {
      const newSets = [...buffSets];
      const [moved] = newSets.splice(fromIndex, 1);
      newSets.splice(toIndex, 0, moved);
      setBuffSets(newSets);
    }
    setDraggingBuffSetId(null);
    setDragOverBuffSetId(null);
  };

  const handleBuffSetDragEnd = () => {
    setDraggingBuffSetId(null);
    setDragOverBuffSetId(null);
  };

  // --- Drag and Drop Handlers for Buffs ---
  const handleBuffDragStart = (e, buffId) => {
    setDraggingBuffId(buffId);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', buffId);
  };

  const handleBuffDragOver = (e, buffId) => {
    e.preventDefault();
    if (draggingBuffId && draggingBuffId !== buffId) {
      setDragOverBuffId(buffId);
    }
  };

  const handleBuffDragLeave = () => {
    setDragOverBuffId(null);
  };

  const handleBuffDrop = (e, targetId) => {
    e.preventDefault();
    if (!draggingBuffId || draggingBuffId === targetId) {
      setDraggingBuffId(null);
      setDragOverBuffId(null);
      return;
    }
    const fromIndex = buffs.findIndex(b => b.id === draggingBuffId);
    const toIndex = buffs.findIndex(b => b.id === targetId);
    if (fromIndex !== -1 && toIndex !== -1) {
      const newBuffs = [...buffs];
      const [moved] = newBuffs.splice(fromIndex, 1);
      newBuffs.splice(toIndex, 0, moved);
      setBuffs(newBuffs);
    }
    setDraggingBuffId(null);
    setDragOverBuffId(null);
  };

  const handleBuffDragEnd = () => {
    setDraggingBuffId(null);
    setDragOverBuffId(null);
  };

  // --- Import / Export Handlers ---

  const handleExport = () => {
    const data = {
      version: 1,
      rows,
      buffs,
      buffSets,
      activeBuffIds: Array.from(activeBuffIds),
      activeBuffSetId,
      activeTargetId
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'logic-chain.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleImportClick = () => {
    _optionalChain([fileInputRef, 'access', _15 => _15.current, 'optionalAccess', _16 => _16.click, 'call', _17 => _17()]);
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setIsLoading(true);

    setTimeout(() => {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);

                if (!data.rows || !Array.isArray(data.rows)) throw new Error("Invalid rows data");
                if (!data.buffs || !Array.isArray(data.buffs)) throw new Error("Invalid buffs data");

                setRows(data.rows);
                setBuffs(data.buffs);
                setBuffSets(data.buffSets || []);
                setActiveBuffIds(new Set(data.activeBuffIds || []));
                setActiveBuffSetId(data.activeBuffSetId || null);

                if (data.activeTargetId && data.rows.find(r => r.id === data.activeTargetId)) {
                setActiveTargetId(data.activeTargetId);
                } else if (data.rows.length > 0) {
                setActiveTargetId(data.rows[data.rows.length - 1].id);
                }

            } catch (err) {
                setImportError("Failed to import JSON: " + err.message);
            } finally {
                setTimeout(() => {
                    setIsLoading(false);
                    e.target.value = null;
                }, 500);
            }
        };
        reader.readAsText(file);
    }, 100);
  };

  const handleShare = async () => {
    setShareStatus('copying');
    try {
      const state = {
        rows,
        buffs,
        buffSets,
        activeBuffIds: Array.from(activeBuffIds),
        activeBuffSetId,
        activeTargetId
      };
      const encoded = encodeStateToUrl(state);
      if (!encoded) {
        throw new Error('Failed to encode state');
      }

      const baseUrl = window.location.origin + window.location.pathname;
      const shareUrl = `${baseUrl}?d=${encoded}`;

      await navigator.clipboard.writeText(shareUrl);
      setShareStatus('copied');
      setTimeout(() => setShareStatus(null), 2500);
    } catch (err) {
      console.log('Share error:', err);
      setShareStatus('error');
      setTimeout(() => setShareStatus(null), 2500);
    }
  };

  const handleConfirmSharedState = () => {
    if (!pendingSharedState) return;

    // Load the shared state
    setRows(pendingSharedState.rows || rows);
    setBuffs(pendingSharedState.buffs || buffs);
    setBuffSets(pendingSharedState.buffSets || buffSets);
    setActiveBuffIds(new Set(pendingSharedState.activeBuffIds || []));
    setActiveBuffSetId(pendingSharedState.activeBuffSetId || null);

    if (pendingSharedState.activeTargetId) {
      setActiveTargetId(pendingSharedState.activeTargetId);
    }

    // Clear the pending state and show banner
    setPendingSharedState(null);
    setShowUrlBanner(true);

    // Clear the URL parameter without reloading
    const newUrl = window.location.origin + window.location.pathname;
    window.history.replaceState({}, '', newUrl);
  };

  const handleCancelSharedState = () => {
    setPendingSharedState(null);

    // Clear the URL parameter without reloading
    const newUrl = window.location.origin + window.location.pathname;
    window.history.replaceState({}, '', newUrl);
  };


  const activeRowObj = rows.find(r => r.id === activeTargetId) || rows[rows.length - 1];
  const finalTree = _optionalChain([mainResult, 'access', _18 => _18.computed, 'access', _19 => _19[_optionalChain([activeRowObj, 'optionalAccess', _20 => _20.name])], 'optionalAccess', _21 => _21.displayTree]) || null;
  const finalValue = _optionalChain([mainResult, 'access', _22 => _22.computed, 'access', _23 => _23[_optionalChain([activeRowObj, 'optionalAccess', _24 => _24.name])], 'optionalAccess', _25 => _25.value]) || 0;
  const allValidTargets = rows.map(i => i.name).filter(Boolean);

  return (
    _react2.default.createElement('div', { className: "max-w-7xl mx-auto p-6 bg-slate-50 min-h-screen font-sans text-slate-800 relative"       ,}

      /* Loading Overlay */
      , isLoading && (
        _react2.default.createElement('div', { className: "fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center transition-opacity"        ,}
            , _react2.default.createElement('div', { className: "bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center gap-4 animate-in fade-in zoom-in duration-200"           ,}
                , _react2.default.createElement(_lucidereact.Loader2, { className: "w-12 h-12 text-indigo-600 animate-spin"   ,} )
                , _react2.default.createElement('div', { className: "text-center",}
                    , _react2.default.createElement('h3', { className: "text-lg font-bold text-slate-800"  ,}, "Importing Data" )
                    , _react2.default.createElement('p', { className: "text-slate-500 text-sm" ,}, "Parsing configuration and recalculating..."   )
                )
            )
        )
      )

      /* Error Modal */
      , importError && (
        _react2.default.createElement('div', { className: "fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center"       ,}
            , _react2.default.createElement('div', { className: "bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4"       ,}
                , _react2.default.createElement('div', { className: "flex items-center gap-3 mb-4"   ,}
                    , _react2.default.createElement(_lucidereact.AlertCircle, { className: "w-6 h-6 text-red-500"  ,} )
                    , _react2.default.createElement('h3', { className: "text-lg font-bold text-slate-800"  ,}, "Import Error" )
                )
                , _react2.default.createElement('p', { className: "text-slate-600 text-sm mb-4"  ,}, importError)
                , _react2.default.createElement('button', {
                    onClick: () => setImportError(null),
                    className: "w-full py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors font-medium"       ,}
                    , "OK"
                )
            )
        )
      )

      /* Shared Link Confirmation Modal */
      , pendingSharedState && (
        _react2.default.createElement('div', { className: "fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center",}
            , _react2.default.createElement('div', { className: "bg-white p-6 rounded-xl shadow-2xl max-w-md w-full mx-4",}
                , _react2.default.createElement('div', { className: "flex items-center gap-3 mb-4",}
                    , _react2.default.createElement(_lucidereact.Share2, { className: "w-6 h-6 text-emerald-600",})
                    , _react2.default.createElement('h3', { className: "text-lg font-bold text-slate-800",}, "Load Shared Configuration?")
                )
                , _react2.default.createElement('p', { className: "text-slate-600 text-sm mb-2",}
                    , "Someone shared a Logic Chain configuration with you. Loading it will replace your current data."
                )
                , _react2.default.createElement('div', { className: "bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4",}
                    , _react2.default.createElement('div', { className: "flex items-start gap-2",}
                        , _react2.default.createElement(_lucidereact.AlertCircle, { className: "w-4 h-4 text-amber-600 mt-0.5 shrink-0",})
                        , _react2.default.createElement('p', { className: "text-amber-800 text-xs",}
                            , _react2.default.createElement('span', { className: "font-semibold",}, "Warning:")
                            , " This will overwrite your locally saved configuration. Your current data will be lost."
                        )
                    )
                )
                , _react2.default.createElement('div', { className: "bg-slate-50 rounded-lg p-3 mb-4 text-xs text-slate-600",}
                    , _react2.default.createElement('div', { className: "font-semibold text-slate-700 mb-1",}, "Shared configuration contains:")
                    , _react2.default.createElement('ul', { className: "space-y-0.5",}
                        , _react2.default.createElement('li', null, "• ", pendingSharedState.rows ? pendingSharedState.rows.length : 0, " calculation rows")
                        , _react2.default.createElement('li', null, "• ", pendingSharedState.buffs ? pendingSharedState.buffs.length : 0, " buffs")
                        , _react2.default.createElement('li', null, "• ", pendingSharedState.buffSets ? pendingSharedState.buffSets.length : 0, " buff sets")
                    )
                )
                , _react2.default.createElement('div', { className: "flex gap-3",}
                    , _react2.default.createElement('button', {
                        onClick: handleCancelSharedState,
                        className: "flex-1 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors font-medium",}
                        , "Keep My Data"
                    )
                    , _react2.default.createElement('button', {
                        onClick: handleConfirmSharedState,
                        className: "flex-1 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium",}
                        , "Load Shared"
                    )
                )
            )
        )
      )

      /* Shared Link Banner */
      , showUrlBanner && (
        _react2.default.createElement('div', { className: "mb-4 bg-emerald-50 border border-emerald-200 rounded-lg p-3 flex items-center justify-between gap-3",}
            , _react2.default.createElement('div', { className: "flex items-center gap-2",}
                , _react2.default.createElement(_lucidereact.Share2, { className: "w-5 h-5 text-emerald-600 shrink-0",})
                , _react2.default.createElement('span', { className: "text-sm text-emerald-800",}
                    , _react2.default.createElement('span', { className: "font-semibold",}, "Shared configuration loaded!")
                    , " You're viewing a shared Logic Chain. Any changes you make will be saved locally."
                )
            )
            , _react2.default.createElement('button', {
                onClick: () => setShowUrlBanner(false),
                className: "text-emerald-600 hover:text-emerald-800 p-1 rounded hover:bg-emerald-100 transition-colors shrink-0",}
                , _react2.default.createElement(_lucidereact.X, { size: 16,})
            )
        )
      )

      , _react2.default.createElement('div', { className: "mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4"      ,}
        , _react2.default.createElement('div', null
          , _react2.default.createElement('h1', { className: "text-2xl font-bold text-slate-900 flex items-center gap-2"     ,}
            , _react2.default.createElement(_lucidereact.Calculator, { className: "text-indigo-600",} ), "Logic Chain Builder"

          )
          , _react2.default.createElement('p', { className: "text-slate-500 mt-2" ,}, "Build a sequential chain of variables. Select any row to visualize its breakdown."

          )
        )

        , _react2.default.createElement('div', { className: "flex items-center gap-2"  ,}
          , _react2.default.createElement('button', {
            onClick: handleShare,
            disabled: isLoading || shareStatus === 'copying',
            className: `flex items-center gap-2 px-4 py-2 border rounded-lg text-sm font-medium transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed ${
              shareStatus === 'copied'
                ? 'bg-emerald-500 border-emerald-500 text-white'
                : shareStatus === 'error'
                ? 'bg-red-500 border-red-500 text-white'
                : 'bg-white border-slate-300 text-slate-700 hover:bg-slate-50 hover:text-emerald-600 hover:border-emerald-300'
            }`,}
            , shareStatus === 'copying' && _react2.default.createElement(_lucidereact.Loader2, { size: 16, className: "animate-spin",})
            , shareStatus === 'copied' && _react2.default.createElement(_lucidereact.Check, { size: 16,})
            , shareStatus === 'error' && _react2.default.createElement(_lucidereact.AlertCircle, { size: 16,})
            , !shareStatus && _react2.default.createElement(_lucidereact.Share2, { size: 16,})
            , shareStatus === 'copied' ? 'Copied!' : shareStatus === 'error' ? 'Failed' : 'Share'
          )
          , _react2.default.createElement('button', {
            onClick: handleExport,
            disabled: isLoading,
            className: "flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 hover:text-indigo-600 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"                 ,}

            , _react2.default.createElement(_lucidereact.Download, { size: 16,} ), " Export JSON"
          )
          , _react2.default.createElement('button', {
            onClick: handleImportClick,
            disabled: isLoading,
            className: "flex items-center gap-2 px-4 py-2 bg-indigo-600 border border-indigo-600 rounded-lg text-sm font-medium text-white hover:bg-indigo-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"                ,}

            , isLoading ? _react2.default.createElement(_lucidereact.Loader2, { size: 16, className: "animate-spin",} ) : _react2.default.createElement(_lucidereact.Upload, { size: 16,} ), "Import JSON"

          )
          , _react2.default.createElement('input', {
            type: "file",
            ref: fileInputRef,
            onChange: handleFileChange,
            accept: ".json",
            className: "hidden",}
          )
        )
      )

      , _react2.default.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-12 gap-8"   ,}

        /* Left Column: The Logic Chain */
        , _react2.default.createElement('div', { className: "lg:col-span-5 space-y-6" ,}

          , _react2.default.createElement('div', { className: "bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden"     ,}
            , _react2.default.createElement('div', { className: "p-4 bg-slate-100 border-b border-slate-200 flex justify-between items-center"      ,}
                , _react2.default.createElement('h2', { className: "font-bold text-slate-700 flex items-center gap-2"    ,}
                    , _react2.default.createElement(_lucidereact.ArrowDown, { size: 18,} ), " Calculation Chain"
                )
                , _react2.default.createElement('span', { className: "text-xs text-slate-400 font-medium uppercase tracking-wider"    ,}, "Top to Bottom"  )
            )

            , _react2.default.createElement('div', { className: "p-4 space-y-0" ,}
                , rows.map((row, index) => {
                    const isError = mainResult.errors[row.id];
                    const comp = mainResult.computed[row.name];
                    const result = _optionalChain([comp, 'optionalAccess', _26 => _26.value]);
                    const isBuffed = _optionalChain([comp, 'optionalAccess', _27 => _27.isBuffed]);
                    const isActive = activeTargetId === row.id;

                    return (
                        _react2.default.createElement('div', { key: row.id, className: "relative group/row" ,}

                            /* Insert Zone Above (Only for first item) */
                            , index === 0 && (
                                _react2.default.createElement('div', { className: "h-4 -mt-2 mb-2 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer group/insert"          , onClick: () => addRowAt(0),}
                                    , _react2.default.createElement('div', { className: "h-[1px] bg-indigo-200 w-full relative"   ,}
                                        , _react2.default.createElement('div', { className: "absolute left-1/2 -top-2.5 -translate-x-1/2 bg-indigo-50 text-indigo-600 border border-indigo-200 rounded-full p-1 shadow-sm transform scale-90 group-hover/insert:scale-100 transition-transform"              ,}
                                            , _react2.default.createElement(_lucidereact.Plus, { size: 12,} )
                                        )
                                    )
                                )
                            )

                            /* The Row Card */
                            , _react2.default.createElement('div', { 
                                className: `
                                    flex flex-col gap-2 p-3 rounded-lg border transition-all relative z-10
                                    ${isActive ? 'bg-indigo-50 border-indigo-300 shadow-md' : 'bg-white border-slate-200 hover:border-indigo-200'}
                                `,}

                                , _react2.default.createElement('div', { className: "flex items-center gap-2"  ,}
                                    /* Selection Radio */
                                    , _react2.default.createElement('button', { 
                                        onClick: () => setActiveTargetId(row.id),
                                        className: `shrink-0 w-8 h-8 rounded-full flex items-center justify-center transition-colors ${isActive ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`,
                                        title: "Visualize this step"  ,}

                                        , _react2.default.createElement(_lucidereact.Eye, { size: 16,} )
                                    )

                                    /* Variable Name */
                                    , _react2.default.createElement('div', { className: "flex items-center bg-slate-100 rounded px-2 py-1 border border-slate-200 focus-within:border-indigo-400 focus-within:ring-1 focus-within:ring-indigo-400"          ,}
                                        , _react2.default.createElement('input', { 
                                            type: "text", 
                                            placeholder: "Name", 
                                            className: "bg-transparent outline-none text-sm font-bold text-slate-700 w-24 placeholder:font-normal"      ,
                                            value: row.name,
                                            onChange: (e) => updateRow(index, 'name', e.target.value),}
                                        )
                                    )

                                    , _react2.default.createElement('div', { className: "text-slate-300",}, "=")

                                    /* Expression */
                                    , _react2.default.createElement('div', { className: "flex-1 relative" ,}
                                        , _react2.default.createElement('input', { 
                                            type: "text", 
                                            placeholder: "Expression (e.g. Base * 2)"    , 
                                            className: "w-full bg-transparent border-b border-slate-200 focus:border-indigo-500 outline-none text-sm py-1 font-mono text-slate-600"         ,
                                            value: row.expression,
                                            onChange: (e) => updateRow(index, 'expression', e.target.value),}
                                        )
                                    )

                                    /* Delete */
                                    , _react2.default.createElement('button', { 
                                        onClick: () => removeRow(index), 
                                        className: "text-slate-300 hover:text-red-500 transition-colors p-1"   ,
                                        disabled: rows.length <= 1,}

                                        , _react2.default.createElement(_lucidereact.Trash2, { size: 14,} )
                                    )
                                )

                                /* Row Footer: Result & Status with Buff Breakdown */
                                , _react2.default.createElement('div', { className: "flex flex-wrap items-center gap-2 text-xs pl-10",}
                                    , isError ? (
                                        _react2.default.createElement('span', { className: "text-red-500 flex items-center gap-1",}, _react2.default.createElement(_lucidereact.AlertCircle, { size: 12,}), " ", isError)
                                    ) : (
                                        _react2.default.createElement(_react2.default.Fragment, null
                                            , _react2.default.createElement('span', { className: "text-slate-400 font-medium",}, "Result:")
                                            , _react2.default.createElement('span', { className: `font-mono px-2 py-0.5 rounded transition-colors ${isBuffed ? 'bg-amber-100 text-amber-700 font-bold' : 'bg-emerald-50 text-emerald-600 font-semibold'}`,}
                                                , result !== undefined ? result.toLocaleString(undefined, { maximumFractionDigits: 2 }) : '-'
                                            )
                                            /* Inline Buff Breakdown - replaces "Buffed" text */
                                            , _optionalChain([comp, 'optionalAccess', _28 => _28.buffBreakdown]) && comp.buffBreakdown.length > 0 && (
                                                _react2.default.createElement(_react2.default.Fragment, null
                                                    , _react2.default.createElement('span', { className: "text-amber-400 mx-0.5",}, "←")
                                                    , comp.buffBreakdown.map((buff, idx) => (
                                                        _react2.default.createElement('div', {
                                                            key: `${buff.buffId}-${idx}`,
                                                            className: "inline-flex items-center gap-1 bg-amber-50 border border-amber-200 rounded px-1.5 py-0.5 text-[10px]",}
                                                            , _react2.default.createElement(_lucidereact.Zap, { size: 8, className: "text-amber-500", fill: "currentColor",})
                                                            , _react2.default.createElement('span', { className: "font-semibold text-amber-700",}, buff.buffName)
                                                            , _react2.default.createElement('span', { className: `font-mono font-bold ${buff.value >= 0 ? 'text-emerald-600' : 'text-red-500'}`,}
                                                                , buff.type === 'mult'
                                                                    ? `${buff.value >= 0 ? '+' : ''}${(buff.value * 100).toFixed(0)}%`
                                                                    : `${buff.value >= 0 ? '+' : ''}${buff.value.toLocaleString()}`
                                                            )
                                                        )
                                                    ))
                                                )
                                            )
                                        )
                                    )
                                )
                            )

                            /* Insert Zone Below */
                            , _react2.default.createElement('div', { className: "h-6 -my-1 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer group/insert relative z-20"           , onClick: () => addRowAt(index + 1),}
                                , _react2.default.createElement('div', { className: "h-[1px] bg-indigo-200 w-full relative"   ,}
                                    , _react2.default.createElement('div', { className: "absolute left-1/2 -top-2.5 -translate-x-1/2 bg-indigo-50 text-indigo-600 border border-indigo-200 rounded-full p-1 shadow-sm transform scale-90 group-hover/insert:scale-100 transition-transform"              ,}
                                        , _react2.default.createElement(_lucidereact.Plus, { size: 12,} )
                                    )
                                )
                            )

                        )
                    );
                })
            )
          )

          /* Buffs Section */
          , _react2.default.createElement('div', { className: "space-y-4 pt-4 border-t border-slate-200"   ,}
            , _react2.default.createElement('div', { className: "flex justify-between items-center mb-2"   ,}
              , _react2.default.createElement('h2', { className: "font-bold text-slate-700 flex items-center gap-2"    ,}
                , _react2.default.createElement(_lucidereact.Zap, { size: 18, className: "text-amber-500", fill: "currentColor",} ), " Buffs"
              )
            )

            /* Buff Sets Panel */
            , _react2.default.createElement('div', { className: "mb-4",}
                , _react2.default.createElement('div', { className: "flex items-center gap-2 mb-2"   ,}
                    , _react2.default.createElement(_lucidereact.Bookmark, { size: 14, className: "text-slate-400",} )
                    , _react2.default.createElement('span', { className: "text-xs font-bold text-slate-500 uppercase tracking-wide"    ,}, "Saved Sets" )
                )

                , _react2.default.createElement('div', { className: "flex flex-col gap-1.5"  ,}
                    , buffSets.length > 0 && buffSets.map(set => {
                        const preview = buffSetPreviews[set.id];
                        const isCurrent = activeBuffSetId === set.id;
                        // Check if current buffs match the saved set's buffs
                        const savedIds = new Set(set.activeIds);
                        const isModified = isCurrent && (
                            savedIds.size !== activeBuffIds.size ||
                            [...savedIds].some(id => !activeBuffIds.has(id))
                        );
                        // Get buff names for preview
                        const buffNames = set.activeIds
                            .map(id => buffs.find(b => b.id === id))
                            .filter(Boolean)
                            .map(b => b.name);
                        const buffPreviewText = buffNames.length > 0
                            ? buffNames.join(', ')
                            : 'No buffs';
                        return (
                            _react2.default.createElement('div', {
                                key: set.id,
                                onDragOver: (e) => handleBuffSetDragOver(e, set.id),
                                onDragLeave: handleBuffSetDragLeave,
                                onDrop: (e) => handleBuffSetDrop(e, set.id),
                                className: `group flex items-center justify-between gap-1 rounded-lg px-3 py-2 text-xs transition-all border-2 ${
                                    draggingBuffSetId === set.id ? 'opacity-50' : ''
                                } ${
                                    dragOverBuffSetId === set.id ? 'border-indigo-500 bg-indigo-50' : ''
                                } ${
                                    isCurrent
                                        ? (isModified
                                            ? 'bg-white border-orange-400 shadow-md ring-2 ring-orange-100'
                                            : 'bg-white border-indigo-400 shadow-md ring-2 ring-indigo-100')
                                        : 'bg-slate-50 border-slate-200 hover:bg-white hover:border-slate-300 hover:shadow-sm cursor-pointer'
                                }`,
                                onClick: () => !isCurrent && loadBuffSet(set),
                                role: isCurrent ? undefined : "button",
                                tabIndex: isCurrent ? undefined : 0,
                                onKeyDown: (e) => !isCurrent && (e.key === 'Enter' || e.key === ' ') && loadBuffSet(set),}
                                , _react2.default.createElement('div', {
                                    draggable: true,
                                    onDragStart: (e) => handleBuffSetDragStart(e, set.id),
                                    onDragEnd: handleBuffSetDragEnd,
                                    className: "shrink-0 cursor-grab active:cursor-grabbing text-slate-300 hover:text-slate-500 touch-none mr-1"    ,
                                    onClick: (e) => e.stopPropagation(),
                                    onMouseDown: (e) => e.stopPropagation(),}
                                    , _react2.default.createElement(_lucidereact.GripVertical, { size: 14,} )
                                )
                                , _react2.default.createElement('div', { className: "flex items-center gap-2 flex-1 min-w-0"    ,}
                                    , _react2.default.createElement(_lucidereact.FolderOpen, { size: 14, className: `shrink-0 ${isCurrent ? (isModified ? 'text-orange-500' : 'text-indigo-500') : 'text-slate-400'}`,} )
                                    , _react2.default.createElement('div', { className: "flex flex-col min-w-0 flex-1"   ,}
                                        , _react2.default.createElement('input', {
                                            type: "text",
                                            value: set.name,
                                            onChange: (e) => {
                                                const newName = e.target.value;
                                                setBuffSets(buffSets.map(s => s.id === set.id ? { ...s, name: newName } : s));
                                            },
                                            onClick: (e) => e.stopPropagation(),
                                            readOnly: !isCurrent,
                                            className: `font-bold bg-transparent outline-none text-xs truncate ${isCurrent ? 'text-slate-800 cursor-text' : 'text-slate-600 cursor-pointer pointer-events-none'}`,
                                            placeholder: "Set Name",
                                        })
                                        , _react2.default.createElement('div', { className: "flex items-center gap-2 text-[10px] min-w-0"    ,}
                                            , _react2.default.createElement('span', { className: "text-slate-400 truncate", title: buffPreviewText,}
                                                , set.activeIds.length, " · ", buffPreviewText
                                            )
                                            , !isCurrent && preview && preview.delta !== 0 && (
                                                _react2.default.createElement('span', { className: `flex items-center gap-0.5 font-bold ${preview.delta > 0 ? 'text-emerald-600' : 'text-red-500'}`,}
                                                    , preview.delta > 0 ? '+' : '', preview.delta.toLocaleString(undefined, { maximumFractionDigits: 0 })
                                                    , _react2.default.createElement('span', { className: "opacity-80",}, "(", preview.percent > 0 ? '+' : '', preview.percent.toFixed(0), "%)")
                                                )
                                            )
                                            , isCurrent && (
                                                isModified ? (
                                                    _react2.default.createElement('span', { className: "text-orange-500 italic font-medium"  ,}, "Modified")
                                                ) : (
                                                    _react2.default.createElement('span', { className: "text-indigo-500 italic font-medium"  ,}, "Active")
                                                )
                                            )
                                        )
                                    )
                                )

                                , _react2.default.createElement('div', { className: "flex items-center gap-1", onClick: (e) => e.stopPropagation(),}
                                    , isModified && _react2.default.createElement('button', {
                                        onClick: () => updateBuffSet(set.id),
                                        className: "p-1.5 text-orange-500 hover:text-orange-700 hover:bg-orange-50 rounded transition-colors"     ,
                                        title: "Save changes to this set"   ,}

                                        , _react2.default.createElement(_lucidereact.Save, { size: 12,} )
                                    )
                                    , _react2.default.createElement('button', {
                                        onClick: () => deleteBuffSet(set.id),
                                        className: "p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded transition-colors"     ,
                                        title: "Delete set" ,}

                                        , _react2.default.createElement(_lucidereact.Trash2, { size: 12,} )
                                    )
                                )
                            )
                        );
                    })

                    , _react2.default.createElement('button', {
                        onClick: createBuffSet,
                        className: "w-full py-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:border-indigo-300 hover:text-indigo-600 hover:bg-indigo-50/50 transition-all flex justify-center items-center gap-2 font-medium text-xs",}
                        , _react2.default.createElement(_lucidereact.Plus, { size: 12,} ), " Create New Set"
                    )
                )
            )

            /* Active Buffs List */
            , buffs.map((buff, bIndex) => {
              const isActive = activeBuffIds.has(buff.id);
              const preview = previews[buff.id];

              return (
                _react2.default.createElement('div', {
                  key: buff.id,
                  onDragOver: (e) => handleBuffDragOver(e, buff.id),
                  onDragLeave: handleBuffDragLeave,
                  onDrop: (e) => handleBuffDrop(e, buff.id),
                  className: `rounded-lg border transition-all ${
                    draggingBuffId === buff.id ? 'opacity-50' : ''
                  } ${
                    dragOverBuffId === buff.id ? 'border-amber-500 ring-2 ring-amber-200' : ''
                  } ${isActive ? 'bg-amber-50 border-amber-200 shadow-sm' : 'bg-white border-slate-200'}`,}
                  , _react2.default.createElement('div', { className: "p-3 flex items-center gap-3 border-b border-slate-100/50"     ,}
                    , _react2.default.createElement('div', {
                        draggable: true,
                        onDragStart: (e) => handleBuffDragStart(e, buff.id),
                        onDragEnd: handleBuffDragEnd,
                        className: "shrink-0 cursor-grab active:cursor-grabbing text-slate-300 hover:text-slate-500 touch-none"    ,}
                        , _react2.default.createElement(_lucidereact.GripVertical, { size: 16,} )
                    )
                    , _react2.default.createElement('input', { type: "checkbox", checked: isActive, onChange: () => toggleBuff(buff.id), className: "w-4 h-4 text-amber-600 rounded focus:ring-amber-500 border-gray-300 cursor-pointer"      ,} )

                    , _react2.default.createElement('div', { className: "flex-1 flex flex-col"  ,}
                      , _react2.default.createElement('input', { type: "text", className: "bg-transparent font-bold text-slate-700 outline-none placeholder:text-slate-400 text-sm"     , value: buff.name, onChange: (e) => updateBuffName(bIndex, e.target.value), placeholder: "Buff Name" ,} )

                      /* Preview Logic */
                      , _react2.default.createElement('div', { className: "flex items-center gap-2 mt-1 text-xs h-4"     ,}
                        , isCalculatingHypotheticals ? (
                            _react2.default.createElement('div', { className: "flex items-center gap-1 text-slate-400"   ,}
                                , _react2.default.createElement(_lucidereact.Loader2, { size: 10, className: "animate-spin",} )
                                , _react2.default.createElement('span', null, "Calculating impact..." )
                            )
                        ) : (
                            _react2.default.createElement(_react2.default.Fragment, null
                                , preview && preview.delta !== 0 && (
                                    _react2.default.createElement(_react2.default.Fragment, null
                                        , _react2.default.createElement('span', { className: "text-slate-400",}
                                                , isActive ? "If removed:" : "If added:"
                                        )

                                            , _react2.default.createElement('span', { className: `flex items-center gap-0.5 font-bold ${preview.delta > 0 ? 'text-emerald-600' : 'text-red-500'}`,}
                                            , preview.delta > 0 ? _react2.default.createElement(_lucidereact.TrendingUp, { size: 10,} ) : _react2.default.createElement(_lucidereact.TrendingDown, { size: 10,} )
                                            , preview.delta > 0 ? '+' : '', preview.delta.toLocaleString(undefined, { maximumFractionDigits: 1 })
                                            , _react2.default.createElement('span', { className: "ml-1 opacity-80" ,}, "("
                                                , preview.percent > 0 ? '+' : '', preview.percent.toLocaleString(undefined, { maximumFractionDigits: 1 }), "%)"
                                            )
                                            )
                                    )
                                )
                                , preview && preview.delta === 0 && (
                                    _react2.default.createElement('span', { className: "text-slate-400 italic" ,}, "No impact on "   , _optionalChain([activeRowObj, 'optionalAccess', _29 => _29.name]))
                                )
                            )
                        )
                      )
                    )

                    , _react2.default.createElement('button', { onClick: () => removeBuff(bIndex), className: "text-slate-400 hover:text-red-500" ,}, _react2.default.createElement(_lucidereact.X, { size: 14,} ))
                  )

                  /* Mod List */
                  , _react2.default.createElement('div', { className: "p-3 space-y-2 bg-slate-50/50"  ,}
                    , buff.mods.map((mod, mIndex) => (
                      _react2.default.createElement('div', { key: mod.id, className: "flex items-center gap-2 text-sm"   ,}
                        , _react2.default.createElement('select', { className: "bg-white border border-slate-200 rounded px-2 py-1 text-xs font-semibold text-indigo-700 outline-none focus:border-indigo-400 w-24"           , value: mod.targetVar, onChange: (e) => updateMod(bIndex, mIndex, 'targetVar', e.target.value),}
                          , _react2.default.createElement('option', { value: "", disabled: true,}, "Target...")
                          , allValidTargets.map(name => _react2.default.createElement('option', { key: name, value: name,}, name))
                        )
                        , _react2.default.createElement('div', { className: "flex bg-slate-100 rounded border border-slate-200 p-0.5"     ,}
                          , _react2.default.createElement('button', { className: `p-1 rounded ${mod.type === 'mult' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`, onClick: () => updateMod(bIndex, mIndex, 'type', 'mult'), title: "Multiplier",}, _react2.default.createElement(_lucidereact.Percent, { size: 12,} ))
                          , _react2.default.createElement('button', { className: `p-1 rounded ${mod.type === 'flat' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`, onClick: () => updateMod(bIndex, mIndex, 'type', 'flat'), title: "Flat Value" ,}, _react2.default.createElement(_lucidereact.Hash, { size: 12,} ))
                        )
                        , _react2.default.createElement('input', { type: "number", step: mod.type === 'mult' ? "0.1" : "1", className: "w-16 bg-white border border-slate-200 rounded px-2 py-1 text-xs outline-none focus:border-amber-400"         , value: mod.value, onChange: (e) => updateMod(bIndex, mIndex, 'value', e.target.value),} )
                        , _react2.default.createElement('button', { onClick: () => removeMod(bIndex, mIndex), className: "text-slate-300 hover:text-red-400 ml-auto"  ,}, _react2.default.createElement(_lucidereact.Trash2, { size: 12,} ))
                      )
                    ))
                    , _react2.default.createElement('button', { onClick: () => addModToBuff(bIndex), className: "text-xs text-amber-600 hover:text-amber-700 font-medium flex items-center gap-1 mt-2"       ,}, _react2.default.createElement(_lucidereact.Plus, { size: 12,} ), " Add Modification"  )
                  )
                )
              );
            })
            , _react2.default.createElement('button', { onClick: addBuff, className: "w-full py-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:border-amber-400 hover:text-amber-600 hover:bg-amber-50 transition-all flex justify-center items-center gap-2 font-medium text-sm"                ,}
              , _react2.default.createElement(_lucidereact.Plus, { size: 14,} ), " Create New Buff"
            )
          )
        )

        /* Right Column: Visualization */
        , _react2.default.createElement('div', { className: "lg:col-span-7",}
          , _react2.default.createElement('div', { className: "sticky top-6" ,}
            , _react2.default.createElement('div', { className: "flex justify-between items-center mb-4"   ,}
               , _react2.default.createElement('h2', { className: "font-bold text-slate-700 flex items-center gap-2"    ,}
                , _react2.default.createElement(_lucidereact.Eye, { size: 18,} ), " Visualization"
              )
              , _react2.default.createElement('div', { className: "text-xs font-semibold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100 flex items-center gap-2"           ,}, "Viewing: "
                 , _react2.default.createElement('span', { className: "font-bold",}, _optionalChain([activeRowObj, 'optionalAccess', _30 => _30.name]) || 'Unknown')
              )
            )


            , _react2.default.createElement('div', { className: "bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden min-h-[500px] flex flex-col"        ,}
              , _react2.default.createElement('div', { className: "flex-1 p-8 overflow-auto flex items-center justify-center bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px]"       ,}
                , finalTree ? (
                  _react2.default.createElement('div', { className: "text-lg",}
                    , _react2.default.createElement(FormulaTreeVisualizer, { node: finalTree, computedContext: mainResult.computed,} )
                  )
                ) : (
                  _react2.default.createElement('div', { className: "text-slate-400 text-center" ,}, _react2.default.createElement('p', null, "Select a valid variable to visualize."     ))
                )
              )
              , _react2.default.createElement('div', { className: "bg-slate-900 text-white p-6 border-t border-slate-800"    ,}
                , _react2.default.createElement('div', { className: "flex justify-between items-end"  ,}
                  , _react2.default.createElement('div', null
                    , _react2.default.createElement('div', { className: "text-slate-400 text-sm font-medium mb-1"   ,}, "Final Result (Buffed)"  )
                    , _react2.default.createElement('div', { className: "text-4xl font-bold tracking-tight text-emerald-400 flex items-center gap-3"      ,}
                      , finalValue.toLocaleString(undefined, { maximumFractionDigits: 2 })
                      , _optionalChain([mainResult, 'access', _31 => _31.computed, 'access', _32 => _32[_optionalChain([activeRowObj, 'optionalAccess', _33 => _33.name])], 'optionalAccess', _34 => _34.isBuffed]) && _react2.default.createElement('span', { className: "text-sm bg-amber-500/20 text-amber-400 px-2 py-1 rounded border border-amber-500/30 font-mono"        ,}, "BUFFS APPLIED" )
                    )
                  )
                  , _react2.default.createElement('div', { className: "text-right",}
                    , _react2.default.createElement('div', { className: "text-slate-500 text-xs uppercase tracking-wider font-bold mb-1"     ,}, "Target")
                    , _react2.default.createElement('div', { className: "text-xl font-mono text-white"  ,}, _optionalChain([activeRowObj, 'optionalAccess', _35 => _35.name]))
                  )
                )
              )
            )

            , _react2.default.createElement('div', { className: "mt-4 bg-blue-50 text-blue-700 text-sm p-4 rounded-lg border border-blue-100 flex gap-3"         ,}
              , _react2.default.createElement(_lucidereact.ArrowDown, { className: "shrink-0 mt-0.5" , size: 16,} )
              , _react2.default.createElement('div', null
                , _react2.default.createElement('p', { className: "font-bold",}, "How to use:"  )
                , _react2.default.createElement('p', { className: "opacity-80",}, "1. Define variables in order. You can reference any variable defined above."

                  , _react2.default.createElement('br', null), "2. Hover between rows to "
                       , _react2.default.createElement('span', { className: "font-bold",}, _react2.default.createElement(_lucidereact.Plus, { size: 10, className: "inline",}), " Insert" ), " new variables in the middle of the chain."
                  , _react2.default.createElement('br', null), "3. Use the "
                     , _react2.default.createElement('span', { className: "font-bold",}, "Saved Sets" ), " panel to manage buff configurations. The green/red numbers show how your result would change if you loaded that set."
                )
              )
            )
          )
        )

      )
    )
  );
} exports.default = UnifiedFormulaBuilder;
</script></head>
  <body>
  

<div id="preview-app"></div></body></html>





